"use client";
import React, { useState } from "react";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { useAuth } from "@/context/authContext";
import AccountSettingsModal from "./AccountSettingModal";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { signOut } from "next-auth/react";

const AvatarMenu: React.FC = () => {
 const { user, setUserLocally } = useAuth();
 const [openSettings, setOpenSettings] = useState(false);

 const handleSignOut = async () => {
  setUserLocally(null);

  await signOut({
   callbackUrl: "/login",
  });
 };

 const name = user ? `${user.first_name ?? ""} ${user.last_name ?? ""}`.trim() : "User";
 const email = user?.email ?? ""

 return (
  <>
   <Popover>
    <PopoverTrigger asChild>
     <div className="cursor-pointer">
      <Avatar className="h-40 w-40 border border-gray-300">
       {user?.pic ? (
        <AvatarImage src={user.pic} alt={name} />
       ) : (
        <AvatarFallback>{(user?.first_name ?? "U")[0]}</AvatarFallback>
       )}
      </Avatar>
     </div>
    </PopoverTrigger>
    <PopoverContent align="end" className="w-auto p-16 bg-white">
     <div className="flex flex-col justify-start items-start">
      <div className="font-semibold text-14 text-gray-900">{name || "â€”"}</div>
      {email ? <div className="text-sm text-gray-600">{email}</div> : null}
      <hr className="my-1" />
      <div className="flex justify-start items-center gap-2 mb-8 cursor-pointer" >
       <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g clip-path="url(#clip0_15643_506531)">
         <path d="M9.99984 12.4974C11.3805 12.4974 12.4998 11.3781 12.4998 9.9974C12.4998 8.61668 11.3805 7.4974 9.99984 7.4974C8.61913 7.4974 7.49984 8.61668 7.49984 9.9974C7.49984 11.3781 8.61913 12.4974 9.99984 12.4974Z" stroke="#9AA4B2" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round" />
         <path d="M15.6059 12.2701C15.5051 12.4986 15.475 12.7521 15.5195 12.9978C15.5641 13.2436 15.6812 13.4704 15.8559 13.6489L15.9014 13.6944C16.0422 13.8351 16.154 14.0022 16.2302 14.1861C16.3065 14.3701 16.3457 14.5672 16.3457 14.7663C16.3457 14.9655 16.3065 15.1626 16.2302 15.3465C16.154 15.5305 16.0422 15.6976 15.9014 15.8383C15.7606 15.9792 15.5935 16.0909 15.4096 16.1672C15.2257 16.2434 15.0285 16.2827 14.8294 16.2827C14.6303 16.2827 14.4331 16.2434 14.2492 16.1672C14.0652 16.0909 13.8981 15.9792 13.7574 15.8383L13.712 15.7929C13.5334 15.6182 13.3066 15.501 13.0609 15.4565C12.8151 15.4119 12.5617 15.442 12.3332 15.5429C12.1091 15.6389 11.918 15.7983 11.7834 16.0016C11.6488 16.2048 11.5766 16.443 11.5756 16.6868V16.8156C11.5756 17.2174 11.416 17.6028 11.1318 17.887C10.8477 18.1711 10.4623 18.3307 10.0604 18.3307C9.6586 18.3307 9.27322 18.1711 8.98907 17.887C8.70492 17.6028 8.54529 17.2174 8.54529 16.8156V16.7474C8.53943 16.4966 8.45826 16.2535 8.31235 16.0494C8.16643 15.8454 7.96252 15.69 7.72711 15.6035C7.49861 15.5026 7.24515 15.4725 6.99939 15.5171C6.75364 15.5616 6.52687 15.6788 6.34832 15.8535L6.30287 15.8989C6.16215 16.0398 5.99505 16.1515 5.81111 16.2278C5.62717 16.304 5.43001 16.3433 5.2309 16.3433C5.03178 16.3433 4.83462 16.304 4.65069 16.2278C4.46675 16.1515 4.29965 16.0398 4.15893 15.8989C4.01805 15.7582 3.9063 15.5911 3.83005 15.4072C3.7538 15.2232 3.71455 15.0261 3.71455 14.8269C3.71455 14.6278 3.7538 14.4307 3.83005 14.2467C3.9063 14.0628 4.01805 13.8957 4.15893 13.755L4.20438 13.7095C4.37903 13.531 4.49619 13.3042 4.54075 13.0584C4.58531 12.8127 4.55523 12.5592 4.45438 12.3307C4.35835 12.1067 4.19889 11.9156 3.99564 11.781C3.79239 11.6464 3.55422 11.5741 3.31044 11.5732H3.18166C2.77981 11.5732 2.39443 11.4135 2.11028 11.1294C1.82614 10.8452 1.6665 10.4598 1.6665 10.058C1.6665 9.65616 1.82614 9.27077 2.11028 8.98663C2.39443 8.70248 2.77981 8.54285 3.18166 8.54285H3.24984C3.50059 8.53699 3.74378 8.45582 3.94779 8.3099C4.1518 8.16399 4.3072 7.96007 4.39378 7.72467C4.49462 7.49617 4.5247 7.2427 4.48014 6.99695C4.43558 6.7512 4.31843 6.52443 4.14378 6.34588L4.09832 6.30043C3.95745 6.15971 3.84569 5.99261 3.76944 5.80867C3.69319 5.62473 3.65395 5.42757 3.65395 5.22846C3.65395 5.02934 3.69319 4.83218 3.76944 4.64824C3.84569 4.46431 3.95745 4.2972 4.09832 4.15649C4.23904 4.01561 4.40614 3.90386 4.59008 3.82761C4.77402 3.75136 4.97118 3.71211 5.17029 3.71211C5.36941 3.71211 5.56657 3.75136 5.7505 3.82761C5.93444 3.90386 6.10154 4.01561 6.24226 4.15649L6.28772 4.20194C6.46626 4.37659 6.69303 4.49375 6.93879 4.53831C7.18454 4.58287 7.43801 4.55279 7.6665 4.45194H7.72711C7.95118 4.35591 8.14228 4.19645 8.27688 3.9932C8.41148 3.78995 8.48371 3.55178 8.48469 3.308V3.17921C8.48469 2.77737 8.64432 2.39199 8.92846 2.10784C9.21261 1.82369 9.59799 1.66406 9.99984 1.66406C10.4017 1.66406 10.7871 1.82369 11.0712 2.10784C11.3554 2.39199 11.515 2.77737 11.515 3.17921V3.2474C11.516 3.49117 11.5882 3.72935 11.7228 3.9326C11.8574 4.13585 12.0485 4.2953 12.2726 4.39134C12.5011 4.49218 12.7545 4.52226 13.0003 4.4777C13.246 4.43314 13.4728 4.31598 13.6514 4.14134L13.6968 4.09588C13.8375 3.95501 14.0046 3.84325 14.1886 3.767C14.3725 3.69075 14.5697 3.65151 14.7688 3.65151C14.9679 3.65151 15.1651 3.69075 15.349 3.767C15.5329 3.84325 15.7 3.95501 15.8407 4.09588C15.9816 4.2366 16.0934 4.4037 16.1696 4.58764C16.2459 4.77157 16.2851 4.96874 16.2851 5.16785C16.2851 5.36696 16.2459 5.56413 16.1696 5.74806C16.0934 5.932 15.9816 6.0991 15.8407 6.23982L15.7953 6.28527C15.6206 6.46382 15.5035 6.69059 15.4589 6.93634C15.4144 7.1821 15.4444 7.43557 15.5453 7.66406V7.72467C15.6413 7.94874 15.8008 8.13983 16.004 8.27444C16.2073 8.40904 16.4455 8.48127 16.6892 8.48224H16.818C17.2199 8.48224 17.6052 8.64188 17.8894 8.92602C18.1735 9.21017 18.3332 9.59555 18.3332 9.9974C18.3332 10.3992 18.1735 10.7846 17.8894 11.0688C17.6052 11.3529 17.2199 11.5125 16.818 11.5125H16.7498C16.5061 11.5135 16.2679 11.5858 16.0646 11.7204C15.8614 11.855 15.7019 12.0461 15.6059 12.2701Z" stroke="#9AA4B2" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round" />
        </g>
        <defs>
         <clipPath id="clip0_15643_506531">
          <rect width="20" height="20" fill="white" />
         </clipPath>
        </defs>
       </svg>
       <div className="text-gray-700 text-14 font-semibold p-0" onClick={() => setOpenSettings(true)}>Account settings</div>
      </div>
      <div className="flex justify-start items-center gap-2 cursor-pointer">
       <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M13.3333 14.1667L17.5 10M17.5 10L13.3333 5.83333M17.5 10H7.5M7.5 2.5H6.5C5.09987 2.5 4.3998 2.5 3.86502 2.77248C3.39462 3.01217 3.01217 3.39462 2.77248 3.86502C2.5 4.3998 2.5 5.09987 2.5 6.5V13.5C2.5 14.9001 2.5 15.6002 2.77248 16.135C3.01217 16.6054 3.39462 16.9878 3.86502 17.2275C4.3998 17.5 5.09987 17.5 6.5 17.5H7.5" stroke="#9AA4B2" stroke-width="1.67" stroke-linecap="round" stroke-linejoin="round" />
       </svg>

       <div className="text-gray-700 text-14 font-semibold p-0" onClick={handleSignOut}>Sign out</div>
      </div>
     </div>
    </PopoverContent>
   </Popover >

   <AccountSettingsModal open={openSettings} onOpenChange={setOpenSettings} />
  </>
 );
};

export default AvatarMenu;
